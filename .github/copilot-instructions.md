# Copilot Instructions

- Architecture: React frontend in [client/src](client/src) talks to Node/Express + Socket.IO backend in [server](server). Backend serves REST under `/api` and static assets from [clothes](clothes) and `/uploads` while also handling WebSocket events.
- Local dev: install deps via `./setup.sh` (runs root + client npm install). Start backend with `npm run dev` from repo root (defaults to PORT=5000) and frontend with `npm start` from [client](client). Docker users run `npm run docker:up` (backend on 5001, frontend on 3000); align `PORT`/`REACT_APP_*` envs when switching between native and Docker (compose exports PORT=5001 + REACT_APP_SOCKET_URL=http://localhost:5001).
- Env vars: `.env` at repo root sets `PORT`, `NODE_ENV`, `CLIENT_URL` for CORS. Frontend reads `REACT_APP_API_URL` (defaults http://localhost:5001) and `REACT_APP_SOCKET_URL` (defaults http://localhost:5000) from [client/src/services/socket.js](client/src/services/socket.js) and [client/src/components/ClothSelector.js](client/src/components/ClothSelector.js); keep them consistent with backend port.
- Backend HTTP: [server/index.js](server/index.js) mounts `/api/health`, `/api/clothes` with filtering (category, subcategory, brand, source, search), pagination params (`page`, `limit`), CRUD, bulk import, and `/api/clothes/meta/categories` for filter lists. Data is in-memory (`clothesDB`) seeded from downloaded metadata + SVG fallbacks; restart resets state.
- Static data: [server/routes/clothes.js](server/routes/clothes.js) loads [clothes/products.json](clothes/products.json) if present, otherwise falls back to SVG assets under [clothes/](clothes). When adding new assets ensure `image` paths are web-served (e.g., `/clothes/<file>`).
- Import scripts: [server/scripts/downloadProducts.js](server/scripts/downloadProducts.js) fetches Unsplash/VITON images into [clothes](clothes) and writes `products.json`, attempting bulk import to `/api/clothes/bulk` if the server is running. [server/scripts/downloadSamples.js](server/scripts/downloadSamples.js) pulls sample set and writes `metadata.json`. Run with `node server/scripts/<script>.js` before starting the app if you need real photos.
- Realtime: Socket.IO server in [server/index.js](server/index.js) accepts `video-frame` and `cloth-selected` events; currently echoes processed frames and sends `cloth-applied` acknowledgements. Keep payloads small (backend JSON/body limit set to 50mb) and emit from client only when connected.
- Frontend composition: [client/src/App.js](client/src/App.js) wires `ClothSelector` and `CameraFeed` and shows connection status. `ClothSelector` fetches clothes list with search/category filters; on failure it falls back to local SVG defaults. Selection emits `cloth-selected` via socket and updates `selectedCloth` state.
- Camera/overlay: [client/src/components/CameraFeed.js](client/src/components/CameraFeed.js) opens the webcam (mirrored), runs MediaPipe Pose (`@mediapipe/tasks-vision` from CDN) at ~10 FPS, caches cloth images, and overlays either the real garment image or a gradient-drawn placeholder to fit between shoulders/hips. Respect its refs/caching when modifying loops to avoid dropping frames.
- Socket client: [client/src/services/socket.js](client/src/services/socket.js) creates a singleton socket with websocket transport and limited reconnection; import from here rather than creating new sockets to avoid duplicates.
- ML helper: [server/utils/bodyDetection.js](server/utils/bodyDetection.js) wraps TensorFlow.js BodyPix for segmentation/pose but is not wired into the socket handler yet; reuse this module if you add server-side processing to the `video-frame` path.
- Tests/build: frontend uses CRA scripts (`npm test`, `npm run build`) scoped to [client](client). No backend test harness is present.
- Data resets: because the clothes store lives in memory, any server restart clears runtime mutations (POST/PUT/DELETE). Persist custom data by updating the JSON sources in [clothes](clothes) or re-running the import scripts.
- Common pitfalls: mismatched ports between Docker (5001) and local backend (5000) break API/socket calls; ensure `REACT_APP_API_URL`/`REACT_APP_SOCKET_URL` match. Allow camera permissions in-browser; pose model loads wasm from CDN so offline environments will fail until cached. Large image downloads rely on external URLsâ€”rerun scripts if assets fail.
